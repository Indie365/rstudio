#!/usr/bin/env bash

#
# install-pandoc
#
# Copyright (C) 2009-12 by RStudio, Inc.
#
# Unless you have received this program directly from RStudio pursuant
# to the terms of a commercial license agreement with RStudio, then
# this program is licensed to you under the terms of version 3 of the
# GNU Affero General Public License. This program is distributed WITHOUT
# ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the
# AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
#
#

set -e

VERBOSE=1
source rstudio-tools

# variables that control download + installation process
PANDOC_URL_BASE=https://s3.amazonaws.com/rstudio-buildtools/pandoc/1.19.2.1
PANDOC_VERSION=1.19.2.1-1
PANDOC_VERSION_MACOS=1.19.2.1
PANDOC_CITEPROC_VERSION=0.10.4-1
PANDOC_CITEPROC_VERSION_MACOS=0.10.4

if is-darwin; then
  PANDOC_DIR="pandoc/${PANDOC_VERSION_MACOS}"
else
  PANDOC_DIR="pandoc/${PANDOC_VERSION}"
fi

# remove patch version from pandoc directory (just for
# ease-of-use with CMake installer scripts)
PANDOC_DIR="$(echo "${PANDOC_DIR}" | cut -d"-" -f1)"

# exit early if pandoc already downloaded and installed
if [ -d "${PANDOC_DIR}" ]; then
  echo "Pandoc ${PANDOC_VERSION} already installed"
  exit 0
fi

case "$(platform)" in

"centos")
  PANDOC_SUBDIR=("centos6" "centos7")
  PANDOC_FILES=(
    "pandoc-${PANDOC_VERSION}.x86_64.rpm"
    "pandoc-citeproc-${PANDOC_CITEPROC_VERSION}.x86_64.rpm"
  )
;;

"opensuse")
  PANDOC_SUBDIR=("opensuse-tumbleweed")
  PANDOC_FILES=(
    "pandoc-${PANDOC_VERSION}.x86_64.rpm"
    "pandoc-citeproc-${PANDOC_CITEPROC_VERSION}.x86_64.rpm"
  )
;;

"ubuntu")
  PANDOC_SUBDIR=("ubuntu-$(os-version)")
  PANDOC_FILES=(
    "pandoc_${PANDOC_VERSION}_amd64.deb"
    "pandoc-citeproc_${PANDOC_CITEPROC_VERSION}_amd64.deb"
  )
;;

"darwin")
  PANDOC_SUBDIR=("macos")
  PANDOC_FILES=(
    "pandoc-${PANDOC_VERSION_MACOS}.zip"
    "pandoc-citeproc-${PANDOC_CITEPROC_VERSION_MACOS}.zip"
  )
;;

*)
  echo "Unrecognized platform $(platform); exiting now"
  exit 1

esac

# enter pandoc directory
mkdir -p "${PANDOC_DIR}"
pushd "${PANDOC_DIR}"

# download and extract pandoc
for SUBDIR in "${PANDOC_SUBDIR[@]}"; do
  mkdir -p "${SUBDIR}"

  # enter sub-directory and download + extract files
  pushd "${SUBDIR}"
  for FILE in "${PANDOC_FILES[@]}"; do
    download "${PANDOC_URL_BASE}/${SUBDIR}/${FILE}" "${FILE}"
    extract "${FILE}"
    rm "${FILE}"
  done

  # .deb and .rpm will extract to 'usr/bin' in this folder;
  # pull the binaries out and clean up that folder
  if ! is-darwin; then
    cp usr/bin/pandoc* .
    rm -rf usr
  fi

  # leave the sub-directory
  popd

done

# if we're not on CentOS, then we can just move the pandoc
# binaries to the root folder (out of the subdirectory)
# (on CentOS we package both pandoc binaries)
if ! is-centos; then
  mv "${PANDOC_SUBDIR}"/pandoc* .
  rm -rf "${PANDOC_SUBDIR}"
fi

# return home
popd

