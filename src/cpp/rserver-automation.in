#!/usr/bin/env bash

#
# rserver-automation
#
# Copyright (C) 2022 by Posit Software, PBC
#
# Unless you have received this program directly from Posit Software pursuant
# to the terms of a commercial license agreement with Posit Software, then
# this program is licensed to you under the terms of version 3 of the
# GNU Affero General Public License. This program is distributed WITHOUT
# ANY EXPRESS OR IMPLIED WARRANTY, INCLUDING THOSE OF NON-INFRINGEMENT,
# MERCHANTABILITY OR FITNESS FOR A PARTICULAR PURPOSE. Please refer to the
# AGPL (http://www.gnu.org/licenses/agpl-3.0.txt) for more details.
#
#

# environment variables set from cmake
export RS_CRASH_HANDLER_PATH="$(pwd)/server/crash-handler-proxy/crash-handler-proxy"
export RS_CRASHPAD_HANDLER_PATH="@RSTUDIO_TOOLS_ROOT@/crashpad/crashpad/out/Default/crashpad_handler"
export RS_DB_MIGRATIONS_PATH="@CMAKE_CURRENT_SOURCE_DIR@/server/db"

# use temporary directory for RStudio state
ROOT=$(mktemp -d -p /tmp rstudio-automation-XXXXXX)

export RSTUDIO_CONFIG_HOME="${ROOT}/rstudio-config-home"
export RSTUDIO_CONFIG_DIR="${ROOT}/rstudio-config-dir"
export RSTUDIO_DATA_HOME="${ROOT}/rstudio-data-home"

cat <<- EOF > /tmp/rserver-database.conf
provider=sqlite
directory=${ROOT}
EOF

# run the usual server development script
server/rserver                                          \
	--server-user="$(whoami)"                           \
	--config-file="conf/rserver-dev.conf"               \
	--auth-none=1                                       \
	--www-port=8788                                     \
	--server-data-dir="${ROOT}"                         \
	--database-config-file="/tmp/rserver-database.conf" \
	"$@"

